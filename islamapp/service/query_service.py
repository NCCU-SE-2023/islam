import networkx as nx
from flask import jsonify
from service.util import (
    _gen_error_response,
    INTERNAL_SERVER_ERROR,
    INVALID_INPUT_ERROR,
    NUMBER_EXCEEDED_ERROR
)
from model.query import InvalidInputError,NumberExceededError



def query(request):
    """
    body:
    { 
      "result_num" : 3 
      "accounts" : ["user1","user2","user3"]  (5 most)
    }
    return:
    {
      "accounts" : ["result1","result2"...] 
    }
    """
    try:
      all_account = request.json.get("accounts")
      if(len(all_account)>5):
            raise NumberExceededError(f"The number of accounts cannot exceed 5")
      # for account in all_account:
      #       if account not in db:            #need to fix. When Fixed, uncomment this for-loop.
      #         raise InvalidInputError(f"account {account} not found")
      result_num = request.json.get("result_num")
      

      # 測試acc
      accounts = {
          'account1': { #ch_yj0325
              'followers': [
      "smiling_jiani",
      "shahin.damka",
      "rice_to_islam",
      "alessio_bareato",
      "iris36___",
      "aaa__chichi",
      "imeloiise",
      "sunman.ink",
      "terrywangg",
      "1jnx3wse",
      "realstefan.w",
      "chelsea_li_1017",
      "outlivethemall.y",
      "mattywhyz",
      "j.cheetah",
      "xy.zedd",
      "zino_o99",
      "marshmanagnes45",
      "disappear.0904",
      "connectthefunk",
      "michelle51126",
      "vivizhao86",
      "_ljwljw_",
      "nori_lin_1023",
      "_lms____",
      "2gs.events",
      "shunchi.yang",
      "celia__j",
      "aaa40118",
      "wppggggg__",
      "pei.d",
      "bryan_dvh",
      "kevin.meng__",
      "5lingji",
      "staceyliu_",
      "sasinaj",
      "sonia_piasecki",
      "subinibus_00",
      "hjikim_",
      "junnnso",
      "kat_khue",
      "zziwoong",
      "nanyus.s",
      "fra_tasso",
      "rachel_chen_g",
      "y4tinghu",
      "h0.yin",
      "lenozwh",
      "jequi__",
      "wsqkkk__",
      "jin.illestpunches",
      "hannahpltg",
      "z.way1104",
      "anna_yu_ting",
      "kokonotnut",
      "car_father1",
      "career_esn_rotterdam",
      "htt1998_____.13",
      "ozawa_0827",
      "javi.cona",
      "_jhan0103",
      "giraffeeeeenglish",
      "lejingdaryyy",
      "janeeee._902",
      "l.yh99_emma",
      "jia_janeee",
      "_ren._103",
      "xyzzzzz_328",
      "chiangla_0419",
      "chenwei_111",
      "chiehya_",
      "brianliao004",
      "yushanhuang_8",
      "louis_tricker",
      "bony_202",
      "0620._frank",
      "raylin0312",
      "tfj___kayla",
      "xxun_lee",
      "alekk888",
      "nicazoe",
      "heyitsmelazyboy",
      "caleb_nickelson",
      "yuuuu_____0522",
      "liyichen125",
      "_w.sing_",
      "lindaweng_890531",
      "lai.bpp",
      "chensiqi700",
      "chensiqi7376",
      "clementine_chieh",
      "109207244husam",
      "chuanngggg",
      "henry9011lee",
      "bbflyingdutchman",
      "will.i.am336",
      "nimo_tinnie",
      "anson1030",
      "lemon0707515",
      "xiao0559"
    ],
              'following': [
      "rice_to_islam",
      "yc1102_",
      "luujnn",
      "_iam_chloe_",
      "doramimimama1217",
      "pcl.23",
      "raaaaay_219",
      "hsiang_rhb",
      "louuissiuuol",
      "rosaliie.w",
      "eas.y_go",
      "a_l_i_c_e_min",
      "weiming_jackson",
      "_tsaiiicc_",
      "shiny_1119",
      "nevaeh.0521",
      "jyyannn",
      "l.shu6.l",
      "liyichen125",
      "njz.winnie_snf",
      "__lxxsy__",
      "hsuanii_",
      "chiilao",
      "cdebpm.1028_",
      "shih_yo_9107",
      "ckcf43_lemon",
      "fgh_rovi",
      "wslneo2001",
      "_lil_yu_0126",
      "hdb_andance0724",
      "lh___c___",
      "skys.areblue",
      "mxhxm_0725_",
      "richardlin378",
      "merciless_cannonbolt",
      "gentleman_tor",
      "riceeeone_",
      "po.hsun_",
      "fang.zj",
      "_yh.sabrina_",
      "kevinma_0511",
      "epiphany__1019",
      "sharonnie.74",
      "dragonfly_1014",
      "adrii6nna",
      "cookie_1207_",
      "hazellin__",
      "tsai____ling",
      "_yoko.w",
      "fishjelly_jellyfish",
      "ruiyang_dmc",
      "twenly_lkw",
      "hi_i_am_islander",
      "z.way1104",
      "ch.tongong",
      "ckcfc25_ly",
      "jia_janeee",
      "s.y_betty",
      "_w.sing_",
      "1111111c_",
      "han_yun_1018",
      "hrcdancestudio",
      "fa_aaaan",
      "katiiiyh",
      "yooo__1016",
      "luciiihsu",
      "cclungg0411",
      "hjw_never_mind",
      "xxun_lee",
      "tfc_yihua",
      "kenlin_0415",
      "leonko0808",
      "hai_khun825",
      "anson1030",
      "chopper.571_o417",
      "kaiii_725",
      "_fiona_7452",
      "c.yr_0413",
      "enid_0610",
      "__szuyu__",
      "bryan.tsai905",
      "leojhu_0126",
      "chicken789_",
      "m_a_p_show",
      "angelchang0108",
      "chiwang_tw",
      "kimi_hl2",
      "guoliangyun0304",
      "joryghost",
      "danew_9155",
      "tting031",
      "oi_bangjia0720",
      "elenaweiii_",
      "chi.ling_625",
      "connectthefunk",
      "tsxxi.film",
      "icesharonogs",
      "alicycyee",
      "hsuan_chuang",
      "yuann.xi"
    ]
          },
          'account2': { #hitony____
              'followers': [
      "monica91_19",
      "rice_to_islam",
      "come7781",
      "hair_stylist_blue",
      "bidda_bidda",
      "robertchennnnn",
      "jiang_anson",
      "barnes88103",
      "yt_.1012",
      "keune_mielle_win",
      "iwa_short",
      "chanel_natsu",
      "kentooomi",
      "cahle98",
      "cpmmld",
      "bamboo_nike",
      "smilejie328",
      "canbranbeautyschool",
      "lulure___",
      "imlizkuo",
      "1224_sun",
      "mayumi_78_",
      "vano.share",
      "jonathan__227",
      "ui_salon.official_",
      "zhuanggggggg",
      "ccm129",
      "ohyababe0125",
      "garychicken0313",
      "lulure__",
      "ioio1005",
      "rex830521",
      "dan001550",
      "xstraw915x",
      "c_w_hsu",
      "kay0906",
      "flowerchiu",
      "rie0928",
      "huobd7t",
      "elf_023606",
      "dullsmile",
      "miahsu_1012",
      "59417sunny",
      "emberyeoyo",
      "kunsong_c",
      "decn",
      "ilin1007i",
      "inoombao",
      "cittayan",
      "enrich_live",
      "y628o",
      "min820903",
      "liuf.h",
      "dreamhost824",
      "__mamorooo",
      "garr.ett9565",
      "06__dave__13",
      "shuling_0420",
      "push_hair_weber",
      "c_hau_",
      "jjjjssshbh",
      "yo_ling1114",
      "rebecca._.0823",
      "2353277764we",
      "rm.michael.tw",
      "calon_ginza_maria",
      "eyelash_karan",
      "melindaherrera153",
      "row._.sica59",
      "ed_fiole",
      "evan_self",
      "smartrail",
      "poki721207",
      "hsiao_aaron",
      "kuo_1211",
      "mentor_chiahui",
      "mentor_s257",
      "gp_barber_shop",
      "____fan__ci",
      "t_tore",
      "marsman_store",
      "xiaoliuqiu.island_bistro",
      "yun_shan0604",
      "_19990814",
      "ut______0",
      "poping326",
      "24h__vibing",
      "katty1993224",
      "ooxxkenny",
      "ttalgi_tiff",
      "helloyoyoyoyoyo",
      "mandyweng_",
      "wxwdozowxw_jango",
      "shen_otis",
      "penny11125",
      "navy750204",
      "xue_27922",
      "lh85544",
      "zzt_6539",
      "jie85__20"
    ],
              'following': [
      "rice_to_islam",
      "9cjosh",
      "suzy_makeup_suzy",
      "galaxy___salon",
      "c_w_hsu",
      "1996_0327",
      "cyanmanmagazine",
      "ui_salon.official_",
      "jiube",
      "nikkie__stylist",
      "row._.sica59",
      "minaa_716",
      "ut______0",
      "ayagoto_",
      "kkjyvintage.tw",
      "idea901",
      "cittayan",
      "rayin_hair",
      "yutugratan.oor",
      "sandy.huang.16718",
      "hairinfo_jp",
      "youdai.jp",
      "mao_dong666",
      "foodie.at_talk",
      "shimizu.atsuki",
      "maybe_may.be",
      "tienmuhair",
      "dreamhost824",
      "no69store",
      "shogram_98",
      "keune_mielle_win",
      "uc9688",
      "pengi.japan",
      "9tattoostudio",
      "highbar520",
      "rie0928",
      "alanboom_uca",
      "phoebe_06_",
      "highstreetvision",
      "ttalgi_tiff",
      "luby.1123",
      "_________________ts",
      "ocean_misakichi",
      "blanche_wuyilin",
      "i._hair_nagisa",
      "bf_725",
      "lgibsoncolorist",
      "ftw_fortheweekend",
      "_ninging",
      "rebecca._.0823",
      "gp_barber_shop",
      "una__jc",
      "feat.alan",
      "mcving",
      "wooooko.select",
      "run_fire_ya",
      "may85627",
      "dazedtw",
      "beauty.terminal",
      "drop_tokyo",
      "mengwei_s",
      "ujikawa_rino",
      "vivian.199718",
      "yi_ru_0812",
      "wuyuchiao",
      "ladmusician_tokyo",
      "esc_tw",
      "peekaboosalonsofficial",
      "kurbis_store",
      "lk_store666",
      "multiplay_by_heavyuse",
      "mimivalbuena",
      "anst.tw",
      "gina_masquerade",
      "spider_0617",
      "_rinrin830",
      "hair_stylist_blue",
      "klatch.hair",
      "wtfyou7788",
      "iris_haruka",
      "_msy_a",
      "han9115_",
      "zhao8988",
      "vanessasasa",
      "iam_yui_hair",
      "wxwdozowxw_jango",
      "nikesportswear",
      "shiori.round2",
      "weizeng.1011",
      "megaoyang",
      "_eileen_wu_",
      "sieg_bruce",
      "tseng__h",
      "mars_h_s_u_",
      "lawrence__avery",
      "block_studio__",
      "mandyweng_",
      "kanasakikonomi",
      "chang_034270300",
      "meadowander"
    ]
          },
          'account3': { #yc1102_
              'followers': [
      "wenshin.tsai",
      "john_fx_trader38",
      "jiaj.ia2121",
      "rice_to_islam",
      "kurtalisalismogase",
      "wishlcan",
      "happy_polly_1030",
      "jesse0922_",
      "weslit.30",
      "nhugc20_bluetooth",
      "a_a5a2g41a",
      "xuan.__.1223",
      "yijie0727",
      "ace_business_english",
      "jjtsai_05",
      "yeh_0926",
      "huai4real",
      "_lyh.35___",
      "plz_q1",
      "pop.tar0",
      "sf_ayomrwhite",
      "kuc77777",
      "nung.ze_413",
      "lie7_eovo",
      "jessica_0908_",
      "hznxxi",
      "yu._.chinnn",
      "l.c.h___",
      "kappa.zeb",
      "boog.pop",
      "sandra_shan__13",
      "nevaeh.0521",
      "vin__0420",
      "hw0106",
      "wahasimelon",
      "__lcyr__",
      "wyr_0114",
      "toweroftuts",
      "jie_yan0611",
      "jasmin.rs",
      "osuskaa",
      "moheat_98",
      "official_leef",
      "benjamin.1217",
      "skys.areblue",
      "pl__wy",
      "dwarf0318",
      "jt.1023",
      "lazybone.1110",
      "ab___igail_____",
      "1_tbt_1",
      "wang_cheng_hao",
      "gnps5566",
      "jacodagerald",
      "zzy_051025",
      "nhsd.15tico1121",
      "xiaofon__",
      "newplan57",
      "peih_95",
      "franky.ik",
      "_p.tseng_",
      "maxxam_10_25",
      "yee_chen0204",
      "pworld_5895",
      "muk_.p",
      "jonathan0909_huang",
      "sam_chao_1010",
      "flow3good",
      "donguaguagua",
      "_xunqain_",
      "letsboogie_poppopjoe",
      "hy1iiii",
      "sam0628chen",
      "_martinnnnn__",
      "hsuehush_1031",
      "psl__z._",
      "songen_0801",
      "mawg__",
      "_jadesu",
      "yunln04",
      "liliso0906090",
      "ykl.99",
      "hank10537",
      "flora__24_x",
      "j.wei_622",
      "lee_00126",
      "_hygge.8",
      "treatemrightseer",
      "pop_jyun_",
      "eric_0226_",
      "wasojen",
      "anabioxix",
      "yuyo_liu",
      "s.y_betty",
      "shuan_0927",
      "jilberman24",
      "mu1221_",
      "adrii6nna",
      "cychian__",
      "_bominlish__0117"
    ],
              'following': [
      "rice_to_islam",
      "ch_yj0325",
      "doramimimama1217",
      "pcl.23",
      "hsiang_rhb",
      "rosaliie.w",
      "plum88_",
      "a_l_i_c_e_min",
      "hw0106",
      "_tsaiiicc_",
      "shiny_1119",
      "nevaeh.0521",
      "liyichen125",
      "__lxxsy__",
      "yuyo_liu",
      "xuan.__.1223",
      "shih_yo_9107",
      "ckcf43_lemon",
      "fgh_rovi",
      "haha4ni123",
      "_lil_yu_0126",
      "hdb_andance0724",
      "lh___c___",
      "skys.areblue",
      "mxhxm_0725_",
      "_p.tseng_",
      "merciless_cannonbolt",
      "gogoeri",
      "epiphany__1019",
      "adrii6nna",
      "cookie_1207_",
      "_yoko.w",
      "ruiyang_dmc",
      "_elllf_",
      "twenly_lkw",
      "z.way1104",
      "christineiie59",
      "ckcfc25_ly",
      "jt.1023",
      "_hygge.8",
      "s.y_betty",
      "_w.sing_",
      "1111111c_",
      "katiiiyh",
      "yooo__1016",
      "sincretive",
      "hjw_never_mind",
      "tfc_yihua",
      "kenlin_0415",
      "01._____.08",
      "yijie0727",
      "lih_nntba",
      "leonko0808",
      "stepcrew_life",
      "chopper.571_o417",
      "kaiii_725",
      "cychian__",
      "homie__shiou",
      "enid_0610",
      "bryan.tsai905",
      "pop_jyun_",
      "leojhu_0126",
      "chicken789_",
      "m_a_p_show",
      "danew_9155",
      "oi_bangjia0720",
      "newplan57",
      "tsxxi.film",
      "hsuan_chuang",
      "yuann.xi",
      "hsu_1224_9",
      "jilberman24",
      "simon.0827",
      "ab___igail_____",
      "latte215_",
      "pc_xuan",
      "_chyuu",
      "oonoouy_",
      "wasojen",
      "tristan_shii",
      "edison.2003",
      "t_c_l_u_b",
      "hank10537",
      "puddding_hunter",
      "yzc.sarah__",
      "rexdagg",
      "chihjouuu",
      "1_tbt_1",
      "_lyh.35___",
      "muz.jieyao_official",
      "feedfishfood",
      "sf_ginooo1016",
      "nccusrs",
      "nccu_ps_official",
      "re._fraction",
      "nccu_photo_club",
      "siaw_panda",
      "_huang0106_",
      "nccuboxing",
      "sf_ayomrwhite"
    ]
          }
      }

      # 購建圖
      G = nx.Graph()
      for account, data in accounts.items():
          followers = data['followers']
          following = data['following']
          G.add_edges_from((follower, account) for follower in followers)
          G.add_edges_from((account, followee) for followee in following)

      # K-cores
      k_value = 1  # K=1，確保所有節點都被考慮
      k_cores = nx.k_core(G, k=k_value)

      # 找出前3名最有可能被所有acc都認識的acc
      candidate_scores = {}
      for node in k_cores:
          if node not in accounts.keys():  # 排除已知acc
              count = sum(node in data['followers'] or node in data['following'] for data in accounts.values())
              candidate_scores[node] = count

      top_candidates = sorted(candidate_scores, key=candidate_scores.get, reverse=True)
      if(len(top_candidates)>result_num):
            top_candidates = top_candidates[1:result_num+1]
      return jsonify(top_candidates),201
    #   # print結果
    #   print("Top 3 candidates:")
    #   for candidate in top_candidates:
    #       print(candidate)
    except InvalidInputError as exception:
        return _gen_error_response(
            status_code=404,
            error_code=INVALID_INPUT_ERROR,
            message=f"ISLAM Exception: {str(exception)}",
        )
    except NumberExceededError as exception:
        return _gen_error_response(
            status_code=400,
            error_code=NUMBER_EXCEEDED_ERROR,
            message=f"ISLAM Exception: {str(exception)}",
        )
    except Exception as exception:
        return _gen_error_response(
            status_code=500,
            error_code=INTERNAL_SERVER_ERROR,
            message=f"ISLAM Exception: {str(exception)}",
        )

# query()